<!DOCTYPE html>
<html lang="en">
<head>
    <!--Permite que se muestren correctamente caracteres especiales (acentos, ñ, etc.)-->
    <meta charset="UTF-8">

    <!--Hace que se ajuste a diferentes tamaños de pantalla la pagina-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Centros de Reciclaje en Chile</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    
    <!--Key de la Api-->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBbMQo2xjkf00OTMl6qPKEMDZVdqf5sS4g&libraries=places"></script>
    
    <!--Inicializar el mapa-->
    <script>
        let currentInfoWindow = null;  // Variable global para la ventana de información actual
        let userMarker = null;
        let map;  // Hacer que el mapa sea accesible globalmente

        function initMap() {
            const chileCenter = { lat: -35.6751, lng: -71.542969 }; // Centro aproximado de Chile
            map = new google.maps.Map(document.getElementById("map"), {
                center: chileCenter,
                zoom: 5,
                mapTypeControlOptions: {
                    position: google.maps.ControlPosition.BOTTOM_RIGHT
                }
            });

            // Solicitar la ubicación del usuario
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    // Crear un círculo para representar la ubicación del usuario (en lugar de un marcador)
                    userMarker = new google.maps.Marker({
                        position: userLocation,
                        map: map,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 10, // Tamaño del círculo
                            fillColor: '#00f0d0', // Color del punto
                            fillOpacity: 1,
                            strokeWeight: 0
                        },
                        title: "Tu ubicación"
                    });

                    // Configura la búsqueda en torno a la ubicación del usuario
                    const request = {
                        location: userLocation, // Se usa la ubicación del usuario
                        radius: 200000, // Radio de búsqueda (200 km)
                        keyword: "reciclaje" // Buscar puntos relacionados con reciclaje
                    };

                    // Crea un servicio de Places para buscar lugares de reciclaje cercanos
                    const service = new google.maps.places.PlacesService(map);
                    service.nearbySearch(request, (results, status) => {
                        if (status === google.maps.places.PlacesServiceStatus.OK) {
                            results.forEach(place => {
                                // Crea un marcador para cada centro de reciclaje
                                const marker = new google.maps.Marker({
                                    position: place.geometry.location,
                                    map: map,
                                    title: place.name
                                });

                                // Crear una ventana de información
                                const infowindow = new google.maps.InfoWindow();

                                // Función para cargar la foto del lugar si existe
                                const loadPhoto = (place) => {
                                    if (place.photos && place.photos.length > 0) {
                                        const photo = place.photos[0];
                                        const photoUrl = photo.getUrl({ maxWidth: 400, maxHeight: 300 });
                                        return `<img src="${photoUrl}" alt="Foto de ${place.name}" style="width: 200px; height: auto;">`;
                                    } else {
                                        return `<p>No hay fotos disponibles.</p>`;
                                    }
                                };

                                // Mostrar información con foto al hacer clic en el marcador
                                marker.addListener("click", () => {
                                    // Cerrar la ventana de información anterior si está abierta
                                    if (currentInfoWindow) {
                                        currentInfoWindow.close();
                                    }
                                    const content = `
                                        <h5>${place.name}</h5>
                                        <p>${place.vicinity}</p>
                                        ${loadPhoto(place)}
                                    `;
                                    infowindow.setContent(content);
                                    infowindow.open(map, marker);
                                    currentInfoWindow = infowindow; // Actualizar la ventana de información actual
                                });
                            });
                        } else {
                            console.error("Error al buscar puntos de reciclaje:", status);
                        }
                    });

                    // Mover el mapa a la ubicación del usuario
                    map.setCenter(userLocation);
                    map.setZoom(15); // Acercar el mapa
                }, function() {
                    alert("Error: No se pudo obtener la ubicación");
                });
            } else {
                alert("Error: Tu navegador no soporta la localización");
            }
        }

        // Función para mover el mapa a la ubicación del usuario y hacer zoom progresivo
        function goToUserLocation() {
            if (userMarker) {
                const userLocation = userMarker.getPosition();
                map.panTo(userLocation); // Centrar el mapa en la ubicación del usuario
                map.setZoom(17); // Establecer el zoom de forma que se acerque al nivel de la ubicación
            } else {
                alert("No se ha detectado la ubicación del usuario.");
            }
        }
    </script>

<!--Tamaño del mapa-->
<style>
    #map {
        height: 100vh;
        width: 100%;
    }
    body, html {
        margin: 0;
        padding: 0;
        height: 100%;
    }
    #goToLocationButton {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 5;
        padding: 10px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }
    #goToLocationButton:hover {
        background-color: #00f0d0;
    }
    
    /* Ocultar copyright y condiciones de Google Maps */
    .gm-style-cc {
        display: none !important;
    }
</style>
</head>

<body onload="initMap()">
    <!-- Botón para ir a la ubicación del usuario -->
    <button id="goToLocationButton" onclick="goToUserLocation()">Ir a mi ubicación</button>

    <!-- Mapa -->
    <div id="map"></div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>