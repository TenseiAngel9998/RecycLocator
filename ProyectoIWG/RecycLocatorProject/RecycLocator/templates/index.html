<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centros de Reciclaje en Chile</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    
    <!-- Key de la API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBbMQo2xjkf00OTMl6qPKEMDZVdqf5sS4g&libraries=places"></script>
    
    <script>
        let currentInfoWindow = null;
        let userMarker = null;
        let map;

        function initMap() {
            const chileCenter = { lat: -35.6751, lng: -71.542969 };
            map = new google.maps.Map(document.getElementById("map"), {
                center: chileCenter,
                zoom: 5,
                mapTypeControl: false, // Desactiva el control predeterminado de tipo de mapa
                streetViewControl: false, // Desactiva el control de vista en calle
                fullscreenControl: false // Desactiva el control de pantalla completa
            });

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    // Crear el marcador circular
                    userMarker = new google.maps.Marker({
                        position: userLocation,
                        map: map,
                        icon: getCircleIcon(map.getZoom()),
                        title: "Tu ubicación"
                    });

                    // Ajusta el tamaño del círculo cuando cambia el zoom
                    map.addListener("zoom_changed", () => {
                        const zoomLevel = map.getZoom();
                        userMarker.setIcon(getCircleIcon(zoomLevel));
                    });

                    // Configura la búsqueda de lugares de reciclaje cercanos
                    const request = {
                        location: userLocation,
                        radius: 200000,
                        keyword: "reciclaje"
                    };

                    const service = new google.maps.places.PlacesService(map);
                    service.nearbySearch(request, (results, status) => {
                        if (status === google.maps.places.PlacesServiceStatus.OK) {
                            results.forEach(place => {
                                const marker = new google.maps.Marker({
                                    position: place.geometry.location,
                                    map: map,
                                    title: place.name
                                });

                                const infowindow = new google.maps.InfoWindow();

                                const loadPhoto = (place) => {
                                    if (place.photos && place.photos.length > 0) {
                                        const photo = place.photos[0];
                                        const photoUrl = photo.getUrl({ maxWidth: 400, maxHeight: 300 });
                                        return `<img src="${photoUrl}" alt="Foto de ${place.name}" style="width: 200px; height: auto;">`;
                                    } else {
                                        return `<p>No hay fotos disponibles.</p>`;
                                    }
                                };

                                marker.addListener("click", () => {
                                    if (currentInfoWindow) {
                                        currentInfoWindow.close();
                                    }
                                    const content = `
                                        <h5>${place.name}</h5>
                                        <p>${place.vicinity}</p>
                                        ${loadPhoto(place)}
                                    `;
                                    infowindow.setContent(content);
                                    infowindow.open(map, marker);
                                    currentInfoWindow = infowindow;
                                });
                            });
                        } else {
                            console.error("Error al buscar puntos de reciclaje:", status);
                        }
                    });

                    map.setCenter(userLocation);
                    map.setZoom(15);
                }, function() {
                    alert("Error: No se pudo obtener la ubicación");
                });
            } else {
                alert("Error: Tu navegador no soporta la localización");
            }
        }

        function goToUserLocation() {
            if (userMarker) {
                const userLocation = userMarker.getPosition();
                map.panTo(userLocation);
                map.setZoom(17);
                userMarker.setIcon(getCircleIcon(17));
            } else {
                alert("No se ha detectado la ubicación del usuario.");
            }
        }

        // Alterna entre "Mapa" y "Satélite"
        function toggleMapType() {
            const currentMapType = map.getMapTypeId();
            map.setMapTypeId(currentMapType === 'roadmap' ? 'satellite' : 'roadmap');
        }

        // Función para obtener el tamaño del icono circular basado en el nivel de zoom
        function getCircleIcon(zoomLevel) {
            const scale = zoomLevel >= 15 ? 8 : Math.max(2, 10 - zoomLevel / 2);
            return {
                path: google.maps.SymbolPath.CIRCLE,
                scale: scale,
                fillColor: '#00f0d0',
                fillOpacity: 1,
                strokeColor: '#000000',
                strokeWeight: 2
            };
        }
    </script>

    <style>
        #map {
            height: 100vh;
            width: 100%;
        }
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
        }
        /* Contenedor de los botones */
        .button-container {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
            display: flex;
            flex-direction: column; /* Organiza los botones verticalmente */
            gap: 10px; /* Espacio entre los botones */
        }

        .custom-map-type-button, #goToLocationButton {
            width: 200px; /* Igualar el tamaño de los botones */
            padding: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .custom-map-type-button:hover, #goToLocationButton:hover {
            background-color: #00f0d0;
        }

        /* Ocultar copyright y condiciones de Google Maps */
        .gm-style-cc {
            display: none !important;
        }
    </style>
</head>

<body onload="initMap()">
    <div class="button-container">
        <button class="custom-map-type-button" onclick="toggleMapType()">Mapa/Satélite</button>
        <button id="goToLocationButton" onclick="goToUserLocation()">Ir a mi ubicación</button>
    </div>
    <div id="map"></div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>